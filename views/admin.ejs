<!-- Migrated to the Next.js frontend in /frontend.
     This EJS view is retained only for reference and is not used by the server.
-->


<script>
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user || user.role !== 'admin') {
        alert('Access denied. Admin only.');
        window.location.href = '/';
        return;
    }
    
    loadAdminCars();
    loadAdminBookings();
});

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

async function loadAdminCars() {
    try {
        const response = await fetch('/api/cars');
        const cars = await response.json();
        displayAdminCars(cars);
    } catch (error) {
        console.error('Error loading cars:', error);
    }
}

function displayAdminCars(cars) {
    const container = document.getElementById('adminCarsContainer');
    
    container.innerHTML = cars.map(car => `
        <div class="admin-car-card">
            <div class="car-details">
                <h3>${car.model}</h3>
                <p><strong>Type:</strong> ${car.type}</p>
                <p><strong>Price:</strong> $${car.pricePerDay}/day</p>
                <p><strong>Status:</strong> 
                    <span class="status-${car.availability ? 'available' : 'unavailable'}">
                        ${car.availability ? 'Available' : 'Not Available'}
                    </span>
                </p>
            </div>
            <div class="car-actions">
                <button class="btn btn-danger btn-sm" onclick="deleteCar('${car._id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

async function loadAdminBookings() {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/bookings/all', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const bookings = await response.json();
        displayAdminBookings(bookings);
    } catch (error) {
        console.error('Error loading bookings:', error);
    }
}

function displayAdminBookings(bookings) {
    const container = document.getElementById('adminBookingsContainer');
    
    if (bookings.length === 0) {
        container.innerHTML = '<div class="no-bookings">No bookings found</div>';
        return;
    }
    
    container.innerHTML = bookings.map(booking => `
        <div class="admin-booking-card">
            <div class="booking-details">
                <h3>${booking.carId?.model || 'Unknown Car'}</h3>
                <p><strong>Customer:</strong> ${booking.userId?.name || 'Unknown User'}</p>
                <p><strong>Email:</strong> ${booking.userId?.email || 'N/A'}</p>
                <p><strong>Start Date:</strong> ${new Date(booking.startDate).toLocaleDateString()}</p>
                <p><strong>End Date:</strong> ${new Date(booking.endDate).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="status-${booking.status}">${booking.status}</span></p>
            </div>
            <div class="booking-actions">
                ${booking.status === 'booked' ? 
                    `<button class="btn btn-danger btn-sm" onclick="cancelBookingAdmin('${booking._id}')">Cancel</button>` :
                    ''
                }
            </div>
        </div>
    `).join('');
}

function openAddCarModal() {
    document.getElementById('addCarModal').style.display = 'block';
}

// Close modal
document.querySelector('.close').onclick = function() {
    document.getElementById('addCarModal').style.display = 'none';
}

// Handle add car form
document.getElementById('addCarForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    const formData = new FormData(e.target);
    const carData = {
        model: formData.get('model'),
        type: formData.get('type'),
        pricePerDay: parseInt(formData.get('pricePerDay'))
    };
    
    const messageDiv = document.getElementById('addCarMessage');
    
    try {
        const response = await fetch('/api/cars', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(carData)
        });
        
        if (response.ok) {
            messageDiv.innerHTML = '<div class="success">Car added successfully!</div>';
            setTimeout(() => {
                document.getElementById('addCarModal').style.display = 'none';
                loadAdminCars();
                e.target.reset();
                messageDiv.innerHTML = '';
            }, 2000);
        } else {
            messageDiv.innerHTML = '<div class="error">Failed to add car</div>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<div class="error">Network error</div>';
    }
});

async function deleteCar(carId) {
    if (!confirm('Are you sure you want to delete this car?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/cars/${carId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Car deleted successfully');
            loadAdminCars();
        } else {
            alert('Failed to delete car');
        }
    } catch (error) {
        alert('Error deleting car');
    }
}

async function cancelBookingAdmin(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/bookings/cancel/${bookingId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Booking cancelled successfully');
            loadAdminBookings();
        } else {
            alert('Failed to cancel booking');
        }
    } catch (error) {
        alert('Error cancelling booking');
    }
}
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 Car Rental Service. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>